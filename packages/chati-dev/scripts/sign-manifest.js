/**
 * Sign the framework manifest with Ed25519.
 * Generates manifest.json (file hashes) + manifest.sig (signature).
 *
 * Run: node scripts/sign-manifest.js
 * Requires: .signing-key.pem (generated by generate-signing-key.js)
 */
import { sign, createPrivateKey } from 'crypto';
import { readFileSync, writeFileSync, readdirSync, existsSync } from 'fs';
import { join, dirname, relative } from 'path';
import { fileURLToPath } from 'url';
import { generateManifest } from '../src/installer/manifest.js';

const __dirname = dirname(fileURLToPath(import.meta.url));
const frameworkDir = join(__dirname, '..', 'framework');
const privateKeyPath = join(__dirname, '..', '.signing-key.pem');

if (!existsSync(frameworkDir)) {
  console.error('Framework directory not found. Run bundle-framework.js first.');
  process.exit(1);
}

if (!existsSync(privateKeyPath)) {
  console.warn('No signing key found at .signing-key.pem â€” skipping manifest signing.');
  process.exit(0);
}

function collectFiles(dir, base = dir) {
  let files = [];
  for (const entry of readdirSync(dir, { withFileTypes: true })) {
    const full = join(dir, entry.name);
    if (entry.isDirectory()) {
      files = files.concat(collectFiles(full, base));
    } else if (entry.name !== 'manifest.json' && entry.name !== 'manifest.sig') {
      files.push(relative(base, full));
    }
  }
  return files.sort();
}

const files = collectFiles(frameworkDir);
const version = JSON.parse(readFileSync(join(__dirname, '..', 'package.json'), 'utf-8')).version;
const manifest = generateManifest(frameworkDir, files, version);

const manifestJson = JSON.stringify(manifest, Object.keys(manifest).sort(), 2);

const privateKey = createPrivateKey(readFileSync(privateKeyPath));
const signature = sign(null, Buffer.from(manifestJson), privateKey);

writeFileSync(join(frameworkDir, 'manifest.json'), manifestJson + '\n');
writeFileSync(join(frameworkDir, 'manifest.sig'), signature.toString('base64'));

console.log(`Signed manifest: ${Object.keys(manifest.files).length} files, v${version}`);
